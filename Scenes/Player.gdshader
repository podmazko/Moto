shader_type spatial;
render_mode unshaded, depth_draw_opaque;

// ------------------------
//     UNIFORMS
// ------------------------

uniform sampler2D texture_normal : filter_nearest, repeat_enable;
uniform float normal_depth : hint_range(0.0, 1.0) = 0.3;

// üé® –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —Ü–≤–µ—Ç–∞ –±–ª–∏–∫–∞
uniform sampler2D gradient_texture : filter_linear, hint_default_white;

// –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ (—Ä—É—á–Ω–æ–µ)
uniform vec3 light_direction = vec3(-0.4, -0.6, -0.4);
uniform vec3 light_color = vec3(1.0);

// –°–∏–ª–∞ –±–ª–∏–∫–∞
uniform float specular_strength : hint_range(0.0, 4.0) = 1.5;

// –°–∏–ª–∞ –≤–ª–∏—è–Ω–∏—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
uniform float gradient_intensity : hint_range(0.0, 2.0) = 1.0;

// ------------------------
//     MAIN FRAGMENT
// ------------------------

void fragment() {
    // –ë–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç
    vec3 base_color = vec3(0.5);

    // –í–µ–∫—Ç–æ—Ä –∫–∞–º–µ—Ä—ã
    vec3 view_dir = normalize(VIEW);

    // –ù–æ—Ä–º–∞–ª—å –∏–∑ normal map
    vec3 nmap = texture(texture_normal, UV * 2.0).rgb * 2.0 - 1.0;
    vec3 N = normalize(mix(NORMAL, nmap, normal_depth));

    // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–µ—Ç–∞
    vec3 L = normalize(-light_direction);

    // –í–µ–∫—Ç–æ—Ä –æ—Ç—Ä–∞–∂–µ–Ω–∏—è
    vec3 R = reflect(-L, N);

    // –£–≥–æ–ª –æ—Ç—Ä–∞–∂–µ–Ω–∏—è
    float angle = clamp(dot(R, view_dir), 0.0, 1.0);

    // üé® –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –∏–∑ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
    // –±–µ—Ä—ë–º 1D —Ç–µ–∫—Å—Ç—É—Ä—É, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ = angle
    vec3 grad_color = texture(gradient_texture, vec2(angle, 0.5)).rgb;

    // –£—Å–∏–ª–µ–Ω–∏–µ –±–ª–∏–∫–∞
    float glow = pow(angle, 3.0) * specular_strength;

    // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç
    vec3 final_color = base_color + grad_color * glow * gradient_intensity * light_color;

    ALBEDO = final_color;

    // –õ—ë–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
    EMISSION = grad_color * glow * 0.25;
}
